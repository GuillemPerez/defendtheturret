var JSONexplosion = {
    "frames":
  [ {
        "name":"sprite1",
        "position":{
            "x":0,
            "y":0,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite2",
        "position":{
            "x":128,
            "y":0,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite3",
        "position":{
            "x":256,
            "y":0,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite4",
        "position":{
            "x":384,
            "y":0,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite5",
        "position":{
            "x":0,
            "y":128,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite6",
        "position":{
            "x":128,
            "y":128,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite7",
        "position":{
            "x":256,
            "y":128,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite8",
        "position":{
            "x":384,
            "y":128,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite9",
        "position":{
            "x":0,
            "y":256,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite10",
        "position":{
            "x":128,
            "y":256,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite11",
        "position":{
            "x":256,
            "y":256,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite12",
        "position":{
            "x":384,
            "y":256,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite13",
        "position":{
            "x":0,
            "y":384,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite14",
        "position":{
            "x":128,
            "y":384,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite15",
        "position":{
            "x":256,
            "y":384,
            "w":128,
            "h":128
        }
    },
    {
        "name":"sprite16",
        "position":{
            "x":384,
            "y":384,
            "w":128,
            "h":128
        }
    },
    
  ]
}
var JSONfood = {
  "framesfood":
[ {
      "name":"sprite1",
      "position":{
          "x":0,
          "y":0,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite2",
      "position":{
          "x":100,
          "y":0,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite3",
      "position":{
          "x":200,
          "y":0,
          "w":100,
          "h":65.2
      }
  }
  ,
  {
      "name":"sprite4",
      "position":{
          "x":300,
          "y":0,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite5",
      "position":{
          "x":400,
          "y":0,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite6",
      "position":{
          "x":0,
          "y":65.2,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite7",
      "position":{
          "x":100,
          "y":65.2,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite8",
      "position":{
          "x":200,
          "y":65.2,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite9",
      "position":{
          "x":300,
          "y":65.2,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite10",
      "position":{
          "x":400,
          "y":65.2,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite11",
      "position":{
          "x":0,
          "y":130.4,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite12",
      "position":{
          "x":100,
          "y":130.4,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite13",
      "position":{
          "x":200,
          "y":130.4,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite14",
      "position":{
          "x":300,
          "y":130.4,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite15",
      "position":{
          "x":400,
          "y":130.4,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite16",
      "position":{
          "x":0,
          "y":195.6,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite17",
      "position":{
          "x":100,
          "y":195.6,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite18",
      "position":{
          "x":100,
          "y":195.6,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite19",
      "position":{
          "x":200,
          "y":195.6,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite20",
      "position":{
          "x":300,
          "y":195.6,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite21",
      "position":{
          "x":400,
          "y":195.6,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite22",
      "position":{
          "x":0,
          "y":260.8,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite23",
      "position":{
          "x":100,
          "y":260.8,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite24",
      "position":{
          "x":200,
          "y":260.8,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite25",
      "position":{
          "x":300,
          "y":260.8,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite26",
      "position":{
          "x":400,
          "y":260.8,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite27",
      "position":{
          "x":0,
          "y":326,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite28",
      "position":{
          "x":100,
          "y":326,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite29",
      "position":{
          "x":200,
          "y":326,
          "w":100,
          "h":65.2
      }
  },
  {
      "name":"sprite30",
      "position":{
          "x":300,
          "y":326,
          "w":100,
          "h":65.2
      }
  }
]

}
let segLength = 30,
  x,
  y,
  x2,
  y2;

var lasers = [];
var badfoods = [];
var angle2;

var carrot_img;
var coco_img;
var background_img;
var col;
var score;
var player;
var input; 
var start;
var num = 100;


let  spritedata;
let  spritesheet;
let animation = [];
let shotsound;
let spritedataexplosion;
let spritesheetexplosion;
let animationexplosion = [];


function preload(){
    spritesheetexplosion = loadImage('img/explosion.png');
 spritedata = loadJSON('food.json');
 spritesheet = loadImage('img/food.png');
  carrot_img = loadImage('img/carrot2.png');
  coco_img = loadImage('img/bullet.png');
  background_img = loadImage('img/background.jpg');
  shotsound = loadSound("sounds/shot.wav");
 

}

function setup() {
  
    let crc=createCanvas(590, 450);
    crc.parent('section2');

    input = createInput("Posa el que vulguis...")
    input.parent('aside');
  
    player = new player('user');
  let frames  = JSONfood.framesfood;
  let frames2 = JSONexplosion.frames;
  
  for (let i = 0; i<frames2.length; i++){
    let pos2 = frames2[i].position;
    let img2 = spritesheetexplosion.get(pos2.x,pos2.y,pos2.w,pos2.h);
    animationexplosion.push(img2);
    
  }
  for (let i = 0; i<frames.length; i++){
    let pos = frames[i].position;
    let img = spritesheet.get(pos.x,pos.y,pos.w,pos.h);
    animation.push(img);
  }

  strokeWeight(20);
  stroke(0);
  

  score = 0;
  x = width / 2;
  y = height / 2;
  x2 = x;
  y2 = y;
  for(var i = 0; i<20 ; i++){
    var n = int(random(30));
    badfoods.push(new food(animation,n,randomPositionX()));
   
  }


}

function draw() {
    if(start){
        if(player.live >0){
  
            background(background_img);
            CheckLevel();
          
          
          
            for(var i=0; i<badfoods.length; i++){
              
              badfoods[i].render(animation);
              badfoods[i].update();
              if(badfoods[i].timedestroy()){
                  badfoods.splice(i,1);
                }
          
                if(badfoods[i].hitmidle()){
                  badfoods.splice(i,1);
                  player.live -=1;
                }
          
            }
          
            for(var i = 0; i < lasers.length; i++){
              lasers[i].render();
              lasers[i].update();
          
          
          
              for(var j=0; j<badfoods.length; j++){
                if(lasers[i].hits(badfoods[j])){
                    image(animationexplosion[frameCount % 12] , badfoods[j].pos.x-45, badfoods[j].pos.y-45);
                  badfoods.splice(j,1);
                  player.score+=10;
                  player.numShots+=1;
                }
              }
              
              
                  if(lasers[i].timedestroy()){
                      lasers.splice(i,1);
                    }
              
            }
            
            dragSegment(0, mouseX, mouseY);
            textSize(20);
            fill(255);
            
              text('Score: '+ player.score, 10, 30);
              text('Shots: '+ player.numShots, 500, 30);
              text('Vida: '+ player.live, 250, 30);
              textSize(10);
              text(input.value(),10,445);
              
          }
          else {
              background(0);
              stroke(0);
              fill(255);
              textSize(30);
              text('Game Over', 215, 200);
              text('Score: '+ player.score, 230, 300);
              text('Click per tornar a jugar...', 130, 400);
              
           }
          
            
          
        }
    
    
    else{
        background(0);
              stroke(0);
              fill(255);
              textSize(30);
              text('Click per començar...', 140, 200);
              
    }
}
  

function randomPositionX(){
    var x1 = random(width, width+200);
    var x2 = random(-200, -50);
    var x = int(random(0,3));
    
    if(x == 1){
        return x1;
    } else {
        return x2;
    }
}


function CheckLevel() {
    
    if(player.score == 200){
        num = 50;
    }

    if(player.score == 500){
        num = 20;
    }

    if(player.score == 1000){
        num = 10;
    }

    if(int(random(num)) == 4){
        generador();
    }
}

function getDistance(x1,x2,y1,y2){
  let xDistance = x2-x1;
  let yDistance = y2-y1;
  return Math.sqrt(Math.pow(xDistance,2)+ Math.pow(yDistance,2));
}

function dragSegment(i, xin, yin) {
  

  dx = mouseX - x;
  dy = mouseY - y;
  angle2 = atan2(dy, dx);
  segment(x2, y2, angle2);
}

function segment(x, y, a) {
  push();
  translate(x, y);
  rotate(a);
  image(carrot_img,width/2,height/2);
  image(carrot_img,-30,-10,carrot_img.width / 2,carrot_img.height / 2);
  //line(0, 0, segLength, 0);
  pop();
}

function generador(){

    for(var i = 0; i<10; i++){
        var n = int(random(30));
        badfoods.push(new food(animation,n,randomPositionX()));
        
      }
}

function mousePressed() {
    if(player.numShots>0){
        lasers.push(new Laser(createVector(width/2,height/2),angle2, coco_img));
        shotsound.play();
        player.numShots-=1;
    }
    if(!start){
        start=true;
    }

    if(player.live == 0){
        GameUpdate();
    }
  }
  function GameUpdate() {

    player.live = 3;
    player.numShots = 5;
    player.score = 0;

  }
